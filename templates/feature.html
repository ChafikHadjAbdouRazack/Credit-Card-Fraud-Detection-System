<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Feature Importance</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <nav class="sidebar">
      <h2>Fraud Detection</h2>
      <a href="index.html">Dashboard</a>
      <a href="visualizations.html">Visualizations</a>
      <a href="analysis.html">Analysis</a>
      <a href="model.html">ML Model</a>
      <a href="amount-trends.html">Amount Trends</a>
      <a href="feature.html" class="active">Feature</a>
      <a href="theory.html">Theory</a>
    </nav>
    <div class="main-content">
      <h1>Feature Importance</h1>
      <input type="file" id="csvFile" accept=".csv" />
      <div class="dashboard-section">
        <h2>Top Contributing Features for Fraudulent Transactions</h2>
        <div id="feature-importance" class="plot-container"></div>
      </div>
      <div class="dashboard-section">
        <h2>Correlation Heatmap of Features</h2>
        <div id="correlation-heatmap" class="plot-container"></div>
      </div>
    </div>
    <script>
      document
        .getElementById("csvFile")
        .addEventListener("change", function (e) {
          if (!e.target.files.length) return;
          Papa.parse(e.target.files[0], {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function (results) {
              const data = results.data;
              renderFeatureImportance(data);
            },
          });
        });

      function renderFeatureImportance(data) {
        const columns = Object.keys(data[0]);
        const amountCol = columns.find((c) => c.toLowerCase() === "amount");
        const classCol = columns.find((c) => c.toLowerCase() === "class");
        const featureCols = columns.filter((c) => /^v\d+$/i.test(c));

        // Feature Importance
        let fraudRows = data.filter((row) => row[classCol] == 1);
        let nonFraudRows = data.filter((row) => row[classCol] == 0);
        let featureDiffs = featureCols.map((f) => {
          let meanFraud =
            fraudRows.reduce((a, r) => a + r[f], 0) / (fraudRows.length || 1);
          let meanNonFraud =
            nonFraudRows.reduce((a, r) => a + r[f], 0) /
            (nonFraudRows.length || 1);
          return { feature: f, diff: Math.abs(meanFraud - meanNonFraud) };
        });
        featureDiffs.sort((a, b) => b.diff - a.diff);
        let topFeatures = featureDiffs.slice(0, 10);
        Plotly.newPlot(
          "feature-importance",
          [
            {
              x: topFeatures.map((f) => f.feature),
              y: topFeatures.map((f) => f.diff),
              type: "bar",
              marker: { color: "#0074D9" },
            },
          ],
          {
            title: "Top 10 Features Differentiating Fraudulent Transactions",
            xaxis: { title: "Feature" },
            yaxis: { title: "Mean Difference" },
            paper_bgcolor: "rgba(255,255,255,0.0)",
            plot_bgcolor: "rgba(255,255,255,0.0)",
          }
        );

        // Correlation Heatmap
        function computeCorrelationMatrix(data, features) {
          function mean(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
          }
          function std(arr, m) {
            return Math.sqrt(
              arr.reduce((a, b) => a + Math.pow(b - m, 2), 0) / arr.length
            );
          }
          function corr(x, y) {
            const mx = mean(x),
              my = mean(y);
            const sx = std(x, mx),
              sy = std(y, my);
            const cov =
              x.reduce((a, xi, i) => a + (xi - mx) * (y[i] - my), 0) / x.length;
            return cov / (sx * sy);
          }
          let matrix = [];
          for (let i = 0; i < features.length; i++) {
            matrix[i] = [];
            for (let j = 0; j < features.length; j++) {
              const xi = data.map((row) => row[features[i]]);
              const xj = data.map((row) => row[features[j]]);
              matrix[i][j] = corr(xi, xj);
            }
          }
          return matrix;
        }
        const heatmapFeatures = [...featureCols, amountCol, classCol];
        const corrMatrix = computeCorrelationMatrix(data, heatmapFeatures);
        Plotly.newPlot(
          "correlation-heatmap",
          [
            {
              z: corrMatrix,
              x: heatmapFeatures,
              y: heatmapFeatures,
              type: "heatmap",
              colorscale: "RdBu",
              zmin: -1,
              zmax: 1,
              colorbar: { title: "Correlation" },
            },
          ],
          {
            title: "Correlation Heatmap",
            xaxis: { side: "top" },
            paper_bgcolor: "rgba(255,255,255,0.0)",
            plot_bgcolor: "rgba(255,255,255,0.0)",
          }
        );
      }
    </script>
  </body>
</html>
